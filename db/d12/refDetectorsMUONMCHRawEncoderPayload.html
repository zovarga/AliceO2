<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: Payload Encoder</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('db/d12/refDetectorsMUONMCHRawEncoderPayload.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Payload Encoder </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The <code>EncoderPayload</code> library is building raw data buffer for <em>data payloads</em>. How those payloads are then ordered exactly in memory / on file is not the library business. This choice has been made to minimize the dependency of the Encoder code on the RawDataHeader itself. To that end the Encoder is producing data buffers consisting of (header,payload) <a href="../..//include/MCHRawEncoderPayload/DataBlock.h">blocks</a>, where header is <em>not</em> a RDH but a simpler (and non versioned) struct. Contrary to (RDH,payload) blocks, the payload can be any size (while in RDH the size is limited to 65536 bytes). The part of the detector that a payload block references is identified through the <code>solarId</code> field.</p>
<h2>createPayloadEncoder</h2>
<p>To creation of a MCH PayloadEncoder is handled through a template function. For instance, to create an Encoder that builds raw data in BareFormat and ChargeSumMode, use :</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d1/d2e/PayloadEncoder_8h.html">MCHRawEncoderPayload/PayloadEncoder.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> encoder = o2::mch::raw::createPayloadEncoder&lt;BareFormat,ChargeSumMode&gt;();</div>
</div><!-- fragment --><p>Then for each interaction record (aka orbit,bunch crossing pair) you tell the encoder to start a new Heartbeat Frame, fill it with all the data of the channels and then extract the memory buffer.</p>
<div class="fragment"><div class="line">vector&lt;uint8_t&gt; <a class="code" href="../../dc/da3/glcorearb_8h.html#a3667f558219c90437106b544a3ca00b8">buffer</a>;</div>
<div class="line"><span class="keywordflow">for</span> ( loop over interactions )</div>
<div class="line">  encoder-&gt;startHeartbeatFrame(<a class="code" href="../../db/de1/CompressedHeader_8h.html#ae411a43f26379df8f08328ff93fbf053">orbit</a>,<a class="code" href="../../db/de1/CompressedHeader_8h.html#a516e5fd8e6d262b60bb1e2e64b9801db">bc</a>);</div>
<div class="line">  <span class="keywordflow">for</span> ( loop over digits ) {</div>
<div class="line">    DsElecId elecId = ... <span class="comment">// get electronic dual sampa id from digit</span></div>
<div class="line">      <span class="keywordtype">int</span> sampaChannelId = ... <span class="comment">// get sampa channel id from digits</span></div>
<div class="line">      vector&lt;SampaClusters&gt; <a class="code" href="../../df/d18/namespaceo2_1_1mid.html#aea05eaa7d3f10bbf985231c678b02a57">clusters</a> = ... <span class="comment">// create sampa clusters from digits</span></div>
<div class="line">      encoder-&gt;addChannelData(elecId,sampaChannelId,<a class="code" href="../../df/d18/namespaceo2_1_1mid.html#aea05eaa7d3f10bbf985231c678b02a57">clusters</a>);</div>
<div class="line">  }</div>
<div class="line">encoder-&gt;moveToBuffer(<a class="code" href="../../dc/da3/glcorearb_8h.html#a3667f558219c90437106b544a3ca00b8">buffer</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>At this stage the buffer contains (header,payload) blocks for all the interactions you looped over. But it is <em>not</em> yet a valid raw data, as it lacks RDHs (and has mch-specific headers instead).</p>
<p>The conversion from payload buffers to RDH-base buffers is basically done using the <code>o2::mch::raw::PayloadPaginator</code> class (internally using the <code><a class="el" href="../../d0/d0d/classo2_1_1raw_1_1RawFileWriter.html">o2::raw::RawFileWriter</a></code> framework class). <a class="el" href="../../d2/d88/classA.html">A</a> typical usage example is in the <a href="../../Digit/">digit2raw</a> program.</p>
<h2>Advanced usage</h2>
<p>The <code>createPayloadEncoder</code> actually takes one parameter, a function that converts a solarId into a FeeLinkId (aka a Solar2FeeLinkMapper). The default value should fit the electronic mapping of the actual detector and thus should be fine in most cases. For special use cases a different mapper can be provided though. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div class="ttc" id="aglcorearb_8h_html_a3667f558219c90437106b544a3ca00b8"><div class="ttname"><a href="../../dc/da3/glcorearb_8h.html#a3667f558219c90437106b544a3ca00b8">buffer</a></div><div class="ttdeci">GLuint buffer</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/da3/glcorearb_8h_source.html#l00655">glcorearb.h:655</a></div></div>
<div class="ttc" id="aCompressedHeader_8h_html_ae411a43f26379df8f08328ff93fbf053"><div class="ttname"><a href="../../db/de1/CompressedHeader_8h.html#ae411a43f26379df8f08328ff93fbf053">orbit</a></div><div class="ttdeci">uint32_t orbit</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de1/CompressedHeader_8h_source.html#l00057">CompressedHeader.h:57</a></div></div>
<div class="ttc" id="aCompressedHeader_8h_html_a516e5fd8e6d262b60bb1e2e64b9801db"><div class="ttname"><a href="../../db/de1/CompressedHeader_8h.html#a516e5fd8e6d262b60bb1e2e64b9801db">bc</a></div><div class="ttdeci">uint16_t bc</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de1/CompressedHeader_8h_source.html#l00056">CompressedHeader.h:56</a></div></div>
<div class="ttc" id="anamespaceo2_1_1mid_html_aea05eaa7d3f10bbf985231c678b02a57"><div class="ttname"><a href="../../df/d18/namespaceo2_1_1mid.html#aea05eaa7d3f10bbf985231c678b02a57">o2::mid::clusters</a></div><div class="ttdeci">std::vector&lt; Cluster &gt; clusters</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/dee/testClusterizer_8cxx_source.html#l00190">testClusterizer.cxx:190</a></div></div>
<div class="ttc" id="aPayloadEncoder_8h_html"><div class="ttname"><a href="../../d1/d2e/PayloadEncoder_8h.html">PayloadEncoder.h</a></div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d0/d2f/refDetectors.html">Module &#39;Detectors&#39;</a></li><li class="navelem"><a class="el" href="../../d4/dff/refDetectorsMUON.html">MUON</a></li><li class="navelem"><a class="el" href="../../d0/daf/refDetectorsMUONMCH.html">MCH</a></li><li class="navelem"><a class="el" href="../../d4/dea/refDetectorsMUONMCHRaw.html">Raw CoDec</a></li><li class="navelem"><a class="el" href="../../d4/def/refDetectorsMUONMCHRawEncoder.html">Encoder</a></li>
    <li class="footer">Generated on Mon Feb 14 2022 05:41:08 for Project by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
