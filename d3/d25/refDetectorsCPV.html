<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: CPV</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d3/d25/refDetectorsCPV.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">CPV </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>CPV</h1>
<p>CPV stands for Charged Particles Veto detector which actually is pad chamber with cathode pad readout. There are 3 CPV modules. Each module seats on top of PHOS modules M2, M3 and M4, so the numeration of CPV modules is naturally same: M2, M3, M4. Each module has 128 x 60 = 7680 channels. It is triggered detector and is using CRU (Common Readout Unit) for readout in LHC Run3. More details can be found <a href="https://twiki.cern.ch/twiki/bin/viewauth/ALICE/CPV">here</a>.</p>
<h2>Readout</h2>
<p>CPV readout is organized in 3 GBT links, all connected to single CRU card on single FLP. Triggered events are packed within each HeartBeatFrame. More info about data format can be found <a href="https://twiki.cern.ch/twiki/pub/ALICE/CPV/cpv_data_format.pdf">here</a>.</p>
<h2>Reconstruction</h2>
<p>The reconstruction is steered via <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/Detectors/CPV/workflow/src/cpv-reco-workflow.cxx">o2-cpv-reco-workflow</a> executable. </p><h4>1. Raw to digits</h4>
<p>It starts directly on FLP. Raw data is provided to <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/Detectors/CPV/workflow/src/RawToDigitConverterSpec.cxx">RawToDigitConverter</a> which converts raw format to cpv <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/DataFormats/Detectors/CPV/include/DataFormatsCPV/Digit.h">digits</a> and <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/DataFormats/Detectors/CPV/include/DataFormatsCPV/TriggerRecord.h">trigger records</a>. Digits are calibrated objects: RawToDigitConverter reads <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/DataFormats/Detectors/CPV/include/DataFormatsCPV/Pedestals.h">pedestals</a>, <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/DataFormats/Detectors/CPV/include/DataFormatsCPV/BadChannelMap.h">bad channel map</a> and <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/DataFormats/Detectors/CPV/include/DataFormatsCPV/CalibParams.h">gain</a> calibration objects from CCDB, then it excludes bad channels, subtracts pedestals from raw amplitudes, and result is multiplied by gain calibration coefficient forming the digit which keeps calibrated signal and its channel address. Trigger records are objects which are keeping a reference to digits belonging to same event. To start conversion of raw data to digits run following command: </p><div class="fragment"><div class="line">o2-cpv-reco-workflow --input-type raw --output-type digits --disable-mc --disable-root-output</div>
</div><!-- fragment --><p>If there is no need to calibrate digits, add <code>--pedestal</code> flag to <code>o2-cpv-reco-workflow</code> then digit signal will be equal to raw amplitude. Such mode is used for pedestal calibration (see below). If you want to redirect stream of digits to root file then remove <code>--disable-root-output</code>. If you want to process MC and you need digits to be labeled according to corresponding primary particles then remove <code>--disable-mc</code> flag. Raw decoding itself is done by <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/Detectors/CPV/reconstruction/include/CPVReconstruction/RawDecoder.h">RawDecoder</a> class.</p>
<h4>2. Digits to clusters</h4>
<p>Output of previous command is stream of digits and triggers records. It's expected that the stream from FLP goes to EPNs where clusterization procedure is expected to run. Clusterization is also steered by <code>o2-cpv-reco-workflow</code> executable. In order to run clusterization on digits, run </p><div class="fragment"><div class="line">o2-cpv-reco-workflow --input-type digits --output-type clusters --disable-mc --disable-root-output</div>
</div><!-- fragment --><p>The output of the command is stream of <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/DataFormats/Detectors/CPV/include/DataFormatsCPV/Cluster.h">clusters</a> and corresponding trigger records. Clusterization is done by <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/Detectors/CPV/reconstruction/include/CPVReconstruction/Clusterer.h">Clusterer</a> class.</p>
<h4>3. Clusters to CTF</h4>
<p>Then clusters are ready to be compressed to Compressed Time Frame and to be kept at storage. Try to convert</p>
<h2>Simulation</h2>
<p>Simulation is organized as follows: </p><h4>1. Creation of hits</h4>
<p><a href="https://github.com/AliceO2Group/AliceO2/blob/dev/DataFormats/Detectors/CPV/include/DataFormatsCPV/Hit.h">Hits</a> are objects which keep information about signals such as energy depositions created by single primary particles in detector channels. Hit creation is done by <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/Detectors/CPV/simulation/include/CPVSimulation/Detector.h">Detector</a> class. To run hits creation type </p><div class="fragment"><div class="line">o2-sim -n10 -g boxgen --configKeyValues &#39;BoxGun.pdg=11 ; BoxGun.prange[0]=10.; BoxGun.prange[1]=15.; BoxGun.phirange[0]=260; BoxGun.phirange[1]=280; BoxGun.number=50; BoxGun.eta[0]=-0.125 ; BoxGun.eta[1]=0.125; &#39; -m CPV</div>
</div><!-- fragment --><p>This command will generate 10 events (<code>-n 10</code> option) with uniform particle generator (<code>-g boxgen</code> option) which generates 50 electrons (<code>BoxGun.number=50; BoxGun.pdg=11</code>) with flat momentum distribution in range from 10 GeV/c to 15 GeV/c (<code>BoxGun.prange[0]=10.; BoxGun.prange[1]=15.;</code>), flat azimuthal angle phi distribution in range from 260 to 280 degrees (<code>BoxGun.phirange[0]=260; BoxGun.phirange[1]=280;</code>), flat pseudorapidity distribution in range from -0.125 to 0.125 units (<code>BoxGun.eta[0]=-0.125 ; BoxGun.eta[1]=0.125;</code>), and finally hist only for CPV are created (<code>-m CPV</code>). Result of this command is file o2sim_HitsCPV.root containing hits and some other important stuff.</p>
<h4>2. Hits to digits</h4>
<p>Hits from different primaries then needed to be merged and electronic noise to be added in order to obtain digits from hits. This can be done with <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/Detectors/CPV/simulation/include/CPVSimulation/Digitizer.h">Digitizer</a> workflow. Run </p><div class="fragment"><div class="line">o2-sim-digitizer-workflow --onlyDet CPV</div>
</div><!-- fragment --><p>in order to do so. It merges hits and adds electronic noise to merged signals. Electronic noise is simulated as 3 sigma pedestal jitter. As a result the file You can add &lsquo;--configKeyValues 'CPVSimParams.mCCDBPath=localtest&rsquo;<code>option in order to avoid connection to CCDB and use ideal pedestals (sigma = 1.5 ADC counts for all channels). You can also choose how much sigmas to use for noise simulation providing</code>&ndash;configKeyValues 'CPVSimParams.mZSnSigmas=X'` option, where X is floating point number.</p>
<h4>3. Digits to raw</h4>
<p>Digits can be converted to raw data format using <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/Detectors/CPV/simulation/include/CPVSimulation/RawWriter.h">RawWriter</a> class. Try to run </p><div class="fragment"><div class="line">o2-cpv-digi2raw -o raw/CPV</div>
</div><!-- fragment --><p>This command will read digits from cpvdigits.root by default and produce raw/CPV/ folder with config and raw files. Digits to raw conversion is done by <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/Detectors/CPV/simulation/include/CPVSimulation/RawWriter.h">RawWriter</a> class. You can specify <code>--ccdb-url localtest</code> option in order to use dummy calibration. IMPORTANT is to use same CCDB path as you used at previous step i.e. hits to digits conversion. Input file also can be changed by providing <code>-i path/to/file.root</code> option.</p>
<p>Raw file is ready to be read as normal raw data file and be processed normally with full reconstruction chain like that: </p><div class="fragment"><div class="line">o2-raw-file-reader-workflow --input-conf raw/CPV/CPVraw.cfg |  o2-cpv-reco-workflow --input-type raw --output-type digits --disable-mc --disable-root-output |  o2-cpv-reco-workflow --input-type digits --output-type clusters --disable-mc</div>
</div><!-- fragment --><h2>Calibration</h2>
<p>Calibration is based on <a href="https://github.com/AliceO2Group/AliceO2/tree/dev/Detectors/Calibration#readme">TimeSlotCalibration</a> framework. It supposed to produce calibration objects valid for certain time intervals and put them into CCDB. Calibration processes are expected to be running on EPN using digits and clusters.</p>
<h4><a class="el" href="../../d9/d1f/classPedestals.html" title="CCDB container for the full set of CPV calibration coefficients.">Pedestals</a></h4>
<p>Pedestal calibration is needed to measure pedestal values and their RMSs (sigmas). Pedestal value must be subtracted from amplitude at reconstruction stage. Also pedestals values and sigmas are used to configure FEE thresholds (so-called zero suppression) in physics runs. To measure them pedestal run without zero supression must be taken. Then its raw data converted to digits with <code>--pedestal</code> flag in order not to calibrate it. Thus digits have signal equal to raw amplitude. Then digit stream is picked up by <code>o2-calibration-cpv-calib-workflow</code>. The actual calibration is done by <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/Detectors/CPV/calib/include/CPVCalibration/PedestalCalibrator.h">PedestalCalibrator</a> class inherited from <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/Detectors/Calibration/include/DetectorsCalibration/TimeSlotCalibration.h">TimeSlotCalibration</a>. It produces PedestalSpectrum for each time slot and then finalizing it at the end of TimeSlot or at the end of run. Calibration itself can be run with followng command (it must be within some workflow, of cause): </p><div class="fragment"><div class="line">o2-calibration-cpv-calib-workflow --pedestals --max-delay 0 --tf-per-slot 100</div>
</div><!-- fragment --><p>Option <code>--tf-per-slot 100</code> indicates length of time intervals in TimeFrames. In this particular case length of TimeSlot is 100 TFs. Please consult [this page]() for explanation of all available options. One can also use <code>--updateAtTheEndOfRunOnly</code> option in order to finalize TimeSlots and produce calibration object at the end-of-run only. Be careful with that as end-of-run can be unclear yet within the O2 project so it can never happen. At least with the <code>o2-raw-file-reader-workflow</code> the finalization of TimeSlot never started yet at the end of file reading. Output of <code>o2-calibration-cpv-calib-workflow --pedestals</code> is stream of <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/DataFormats/Detectors/CPV/include/DataFormatsCPV/Pedestals.h">Pedestals</a> objects and corresponding metadata for CCDB entry. Use <code>o2-ccdb-populator-workflow</code> in order to put created objects to CCDB. The overall calibration chain should look like that: </p><div class="fragment"><div class="line">o2-raw-file-reader-workflow --input-conf CPVraw.cfg  | o2-cpv-reco-workflow --input-type raw --output-type digits --disable-mc --disable-root-output --pedestal | o2-calibration-cpv-calib-workflow --pedestals --max-delay 0 --tf-per-slot 100 | o2-calibration-ccdb-populator-workflow</div>
</div><!-- fragment --><p>Explanation: it reads file with pedestal data; then raw data is converted to digits without calibration; then digits are picked up by calibrator; and finally produced calibration objects are putted to CCDB. After that it is possible to read them from CCDB with <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/Detectors/CPV/calib/macros/readPedestalsFromCCDB.C">this script</a>.</p>
<h2>Local testing (quick summary)</h2>
<h4>Simulation</h4>
<div class="fragment"><div class="line">o2-sim -n10 -g boxgen --configKeyValues &#39;BoxGun.pdg=11 ; BoxGun.prange[0]=10.; BoxGun.prange[1]=15.; BoxGun.phirange[0]=260; BoxGun.phirange[1]=280; BoxGun.number=50; BoxGun.eta[0]=-0.125 ; BoxGun.eta[1]=0.125; &#39; -m CPV</div>
<div class="line">o2-sim-digitizer-workflow   --onlyDet CPV #consider to add --configKeyValues &#39;CPVSimParams.mCCDBPath=localtest&#39; to use ideal pedestals for noise simulation</div>
<div class="line">o2-cpv-digi2raw -o raw/CPV</div>
</div><!-- fragment --><h4>Reconstruction</h4>
<div class="fragment"><div class="line">o2-raw-file-reader-workflow --input-conf raw/CPV/CPVraw.cfg |  o2-cpv-reco-workflow --input-type raw --output-type digits --disable-mc --disable-root-output |  o2-cpv-reco-workflow --input-type digits --output-type clusters --disable-mc</div>
</div><!-- fragment --><h4>Pedestal calibration</h4>
<div class="fragment"><div class="line">o2-raw-file-reader-workflow --input-conf CPVraw.cfg  | o2-cpv-reco-workflow --input-type raw --output-type digits --disable-mc --disable-root-output --pedestal | o2-calibration-cpv-calib-workflow --pedestals --max-delay 0 --tf-per-slot 100 | o2-calibration-ccdb-populator-workflow</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d0/d2f/refDetectors.html">Module &#39;Detectors&#39;</a></li>
    <li class="footer">Generated on Mon Feb 14 2022 05:41:07 for Project by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
