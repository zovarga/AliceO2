<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: TPC workflow</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('dd/dac/refTPCworkflow.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">TPC workflow </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>DPL workflows for the TPC</h1>
<h2>TPC reconstruction workflow</h2>
<p>The TPC reconstruction workflow starts from the TPC digits, the <em>clusterer</em> reconstructs clusters in the <a href="../../../../../DataFormats/Detectors/TPC/include/DataFormatsTPC/ClusterHardware.h">ClusterHardware</a> format. The clusters are directly written in the <em>RAW page</em> format. The raw data are passed onto the <em>decoder</em> providing the <a href="../../../../../DataFormats/Detectors/TPC/include/DataFormatsTPC/ClusterNative.h">TPC native cluster</a> format to the <em>tracker</em>.</p>
<p>Note: The format of the raw pages is preliminary and does not reflect what is currently implemented in the CRU.</p>
<p>The workflow consists of the following DPL processors:</p>
<ul>
<li><code>tpc-digit-reader</code> -&gt; using tool <a href="../../../../../Framework/Utils/include/Utils/RootTreeReader.h">o2::framework::RootTreeReader</a></li>
<li><code>tpc-clusterer</code> -&gt; interfaces <a href="../../../reconstruction/include/TPCReconstruction/HwClusterer.h">o2::tpc::HwClusterer</a></li>
<li><code>tpc-cluster-decoder</code> -&gt; interfaces <a href="../../../reconstruction/include/TPCReconstruction/HardwareClusterDecoder.h">o2::tpc::HardwareClusterDecoder</a></li>
<li><code>gpu-reconstruction</code> -&gt; interfaces <a href="../../../reconstruction/include/TPCReconstruction/GPUCATracking.h">o2::tpc::GPUCATracking</a></li>
<li><code>tpc-track-writer</code> -&gt; implements simple writing to <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file</li>
</ul>
<p>Depending on the input and output types the default workflow is extended by the following readers and writers:</p><ul>
<li><code>tpc-raw-cluster-writer</code> writes the binary raw format data to binary branches in a <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file</li>
<li><code>tpc-raw-cluster-reader</code> reads data from binary branches of a <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file</li>
<li><code>tpc-cluster-writer</code> writes the binary native cluster data to binary branches in a <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file</li>
<li><code>tpc-cluster-reader</code> reads data from binary branches of a <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file</li>
</ul>
<p>MC labels are passed through the workflow along with the data objects and also written together with the output at the configured stages (see output types).</p>
<h3>Input data</h3>
<p>The input can be created by running the simulation (<code>o2sim</code>) and the digitizer workflow (<code>digitizer-workflow</code>). The digitizer workflow produces the file <code>tpcdigits.root</code> by default, data is stored in separated branches for all sectors.</p>
<p>The workflow can be run starting from digits, raw clusters, or (native) clusters, or directly attached to the <code>o2-sim-digitizer-workflow</code>, see comment on inputs types below.</p>
<h3>Quickstart running the reconstruction workflow</h3>
<p>The workflow is implemented in the <code>o2-tpc-reco-workflow</code> executable.</p>
<p>Display all options </p><div class="fragment"><div class="line">o2-tpc-reco-workflow --help</div>
</div><!-- fragment --><p>Important options for the <code>tpc-digit-reader</code> as initial publisher </p><div class="fragment"><div class="line">--infile arg                          Name of the input file</div>
<div class="line">--treename arg (=o2sim)               Name of the input tree</div>
<div class="line">--digitbranch arg (=TPCDigit)         Digit branch</div>
<div class="line">--mcbranch arg (=TPCDigitMCTruth)     MC label branch</div>
<div class="line">--nevents                             Number of events</div>
</div><!-- fragment --><p>The <code>tpc-raw-cluster-reader</code> uses the same options except the branch name configuration &ndash;databranch arg (==TPCClusterHw) RAW Cluster branch &ndash;mcbranch arg (==TPCClusterHwMCTruth) MC label branch</p>
<p><a class="el" href="../../db/d4f/structOptions.html">Options</a> for the <code>tpc-track-writer</code> process </p><div class="fragment"><div class="line">--outfile arg (=tpctracks.root)               Name of the output file</div>
<div class="line">--treename arg (=tpcrec)                      Name of tree</div>
<div class="line">--nevents arg (=-1)                           Number of events to execute</div>
<div class="line">--terminate arg (=process)                    Terminate the &#39;process&#39; or &#39;workflow&#39;</div>
<div class="line">--track-branch-name arg (=TPCTracks)          configurable branch name for the tracks</div>
<div class="line">--trackmc-branch-name arg (=TPCTracksMCTruth) configurable branch name for the MC labels</div>
</div><!-- fragment --><p>Examples: </p><div class="fragment"><div class="line">o2-tpc-reco-workflow --infile tpcdigits.root --tpc-sectors 0-17 --tracker-options &quot;cont refX=83 bz=-5.0068597793&quot;</div>
</div><!-- fragment --><div class="fragment"><div class="line">o2-tpc-reco-workflow --infile tpcdigits.root --tpc-sectors 0-17 --disable-mc 1 --tracker-options &quot;cont refX=83 bz=-5.0068597793&quot;</div>
</div><!-- fragment --><h3>Global workflow options:</h3>
<div class="fragment"><div class="line">--input-type arg (=digits)            digitizer, digits, raw, clusters</div>
<div class="line">--output-type arg (=tracks)           digits, raw, clusters, tracks</div>
<div class="line">--disable-mc arg (=0)                 disable sending of MC information</div>
<div class="line">--tpc-lanes arg (=1)                  number of parallel lanes up to the tracker</div>
<div class="line">--tpc-sectors arg (=0-35)             TPC sector range, e.g. 5-7,8,9</div>
</div><!-- fragment --><h4>Input Type</h4>
<p>Input type <code>digitizer</code> will create the clusterers with dangling input, this is used to connect the reconstruction workflow directly to the digitizer workflow.</p>
<p>All other input types will create a publisher process reading data from branches of a <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file. File and branch names are configurable. The MC labels are always read from a parallel branch, the sequence of data and MC objects is assumed to be identical.</p>
<h4>Output Type</h4>
<p>The output type selects up to which final product the workflow is executed. Multiple outputs are supported in order to write data at intermediate steps, e.g. </p><div class="fragment"><div class="line">--output-type raw,tracks</div>
</div><!-- fragment --><p>MC label data are stored in corresponding branches per sector. The sequence of MC objects must match the sequence of data objects.</p>
<p>By default, all data is written to <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> files, even the data in binary format like the raw data and cluster data. This allows to record multiple sets (i.e. timeframes/events) in one file alongside with the MC labels.</p>
<h4>Parallel processing</h4>
<p>Parallel processing is controlled by the option <code>--tpc-lanes n</code>. The digit reader will fan out to n processing lanes, each with clusterer, and decoder. The tracker will fan in from multiple parallel lanes. For each sector, a dedicated DPL data channel is created. The channels are distributed among the lanes. The default configuration processes sector data belonging together in the same time slice, but in earlier implementations the sector data was distributed among multiple time slices (thus abusing the DPL time slice concept). The tracker spec implements optional buffering of the input data, if the set is not complete within one invocation of the processing function.</p>
<h4>TPC sector selection</h4>
<p>By default, all TPC sectors are processed by the workflow, option <code>--tpc-sectors</code> reduces this to a subset.</p>
<h3>Processor options</h3>
<h4>TPC CA tracker</h4>
<p>The <a href="../../src/CATrackerSpec.cxx">tracker spec</a> interfaces the <a href="../../../reconstruction/include/TPCReconstruction/GPUCATracking.h">o2::tpc::GPUCATracking</a> worker class which can be initialized using an option string. The processor spec defines the option <code>--tracker-option</code>. Currently, the tracker should be run with options: </p><div class="fragment"><div class="line">--tracker-option &quot;refX=83 cont&quot;</div>
</div><!-- fragment --><p>The most important tracker options are: </p><div class="fragment"><div class="line">cont    activation of continuous mode</div>
<div class="line">refX=   reference x coordinate, tracker tries to propagate all track to the reference</div>
<div class="line">bz=     magnetic field</div>
</div><!-- fragment --><h3>Current limitations/TODO</h3>
<ul>
<li>the propagation of MC labels goes together with multiple rearrangements and thus copy</li>
<li>raw pages are using RawDataHeader version 2 with 4 64bit words, need to be converted to version 4 also the CRU will pad all words, RawDataHeader and data words to 128 bits, this is not yet reflected in the produced raw data</li>
<li>implement configuration from the GRP</li>
</ul>
<h2>Open questions</h2>
<h2>Calibration workflows</h2>
<h3>Pedestal calibration</h3>
<h4><a class="el" href="../../db/d4f/structOptions.html">Options</a></h4>
<div class="fragment"><div class="line">--direct-file-dump     write final calibration to local root file</div>
<div class="line">--max-events           maximum number of events to process</div>
<div class="line">--no-write-ccdb        don&#39;t send the calibration data via DPL (required in case the calibration write is not attached)</div>
<div class="line">--use-old-subspec      use old subspec definition (CruId &lt;&lt; 16) | ((LinkId + 1) &lt;&lt; (CruEndPoint == 1 ? 8 : 0))</div>
<div class="line">--lanes arg (=1)       number of parallel processes</div>
<div class="line">--sectors arg (=0-35)  list of TPC sectors, comma separated ranges, e.g. 0-3,7,9-15</div>
</div><!-- fragment --><h4>Running with data distribution</h4>
<p>In one shell start the data distribution playback, e.g. </p><div class="fragment"><div class="line">StfBuilder --id builder --data-source-enable --data-source-dir=2020-11-11T14_18_25Z --data-source-rate=100 --dpl-channel-name=dpl-chan  --channel-config &quot;name=dpl-chan,type=pair,method=connect,address=ipc:///tmp/stf-builder-dpl-pipe-0,transport=zeromq,rateLogging=1&quot;</div>
</div><!-- fragment --><p>In another shell start the pedestal calibration </p><div class="fragment"><div class="line">o2-dpl-raw-proxy -b --dataspec &quot;A:TPC/RAWDATA&quot; --channel-config &quot;name=readout-proxy,type=pair,method=bind,address=ipc:///tmp/stf-builder-dpl-pipe-0,transport=zeromq,rateLogging=1&quot; \</div>
<div class="line">| o2-tpc-calib-pedestal  --max-events 5 --direct-file-dump --shm-segment-size $((8&lt;&lt;30)) --no-calib-output --use-old-subspec</div>
</div><!-- fragment --><h4>Running with raw file playback</h4>
<p>Create a raw-reader.cfg e.g. </p><div class="fragment"><div class="line">i=0; echo -e &quot;[defaults]\ndataOrigin = TPC\ndataDescription = RAWDATA\n&quot; &gt; raw-reader.cfg; echo; for file in *.raw; do echo &quot;[input-$i]&quot;; echo &quot;dataOrigin = TPC&quot;; echo &quot;dataDescription = RAWDATA&quot;; echo &quot;filePath=$file&quot;; echo; i=$((i+1)); done &gt;&gt; raw-reader.cfg</div>
</div><!-- fragment --><p>Then run </p><div class="fragment"><div class="line">o2-raw-file-reader-workflow  --input-conf raw-reader.cfg --nocheck-hbf-per-tf --nocheck-hbf-jump --shm-segment-size $((8&lt;&lt;30)) \</div>
<div class="line">|  o2-tpc-calib-pedestal  --max-events 5 --direct-file-dump --shm-segment-size $((8&lt;&lt;30)) --no-calib-output</div>
</div><!-- fragment --><h4>Send data to CCDB</h4>
<p>Remove the <code>--no-write-ccdb</code> option and add </p><div class="fragment"><div class="line">| o2-calibration-ccdb-populator-workflow</div>
</div><!-- fragment --><h3>Laser track calibration</h3>
<h4>Laser track filter</h4>
<p><code>o2-tpc-laser-track-filter</code> filters <code>TPC/TRACKS</code> looking for laser track candidates. The output is provided as <code>TPC/LASERTRACKS</code>. With the option <code>--enable-writer</code>, the filtere tracks can be writte to file (<code>tpc-laser-tracks.root</code>).</p>
<h4>linear workflow reading from a local track file, direclty running the calibration component</h4>
<p>By default <code>o2-tpc-calib-laser-tracks</code> assumes non-filtered <code>TPC/TRACKS</code> as input. Using the option <code>--use-filtered-tracks</code> the input <code>TPC/LASERTRACKS</code> will be used.</p>
<p><b>running without laser track filter</b> </p><div class="fragment"><div class="line">o2-tpc-file-reader --input-type tracks --disable-mc --tpc-track-reader &#39;--infile tpctracks.root&#39; \</div>
<div class="line">  | o2-tpc-calib-laser-tracks --write-debug</div>
</div><!-- fragment --><p><b>running with laser track filter</b> </p><div class="fragment"><div class="line">o2-tpc-file-reader --input-type tracks --disable-mc --tpc-track-reader &#39;--infile tpctracks.root&#39; \</div>
<div class="line">  | o2-tpc-laser-track-filter \</div>
<div class="line">  |  o2-tpc-calib-laser-tracks --use-filtered-tracks --write-debug --run</div>
</div><!-- fragment --><h4>linear workflow reading from a local track file, running with time slot calibration</h4>
<p>The time slot calibration assumes as input prefiltered laser track candates (<code>o2-tpc-laser-track-filter</code>). They are published as <code>TPC/LASERTRACKS</code>.</p>
<h5><a class="el" href="../../db/d4f/structOptions.html">Options</a></h5>
<p>&ndash;tf-per-slot arg (=5000) number of TFs per calibration time slot &ndash;max-delay arg (=3) number of slots in past to consider &ndash;min-entries arg (=100) minimum number of TFs with at least 50 tracks on each sideto finalize a slot so 100 means 5000 matched laser tracks on each side. &ndash;write-debug write a debug output tree.</p>
<div class="fragment"><div class="line">o2-tpc-file-reader --input-type tracks --disable-mc --tpc-track-reader &#39;--infile tpctracks.root&#39; \</div>
<div class="line"> | o2-tpc-laser-track-filter \</div>
<div class="line"> | o2-tpc-laser-tracks-calibrator --write-debug --min-entries 100 --tf-per-slot 5000 --run</div>
</div><!-- fragment --><h4>simple distributed workflow with output and input proxy, running with time slot calibration</h4>
<p><b>Sending side zeromq</b> </p><div class="fragment"><div class="line">o2-tpc-file-reader --input-type tracks --disable-mc --tpc-track-reader &#39;--infile tpctracks.root&#39; \</div>
<div class="line"> | o2-tpc-laser-track-filter \</div>
<div class="line"> | o2-dpl-output-proxy --channel-config &quot;name=downstream,method=connect,address=tcp://localhost:30453,type=push,transport=zeromq&quot; --dataspec lasertracks:TPC/LASERTRACKS -b --run</div>
</div><!-- fragment --><p><b>Receeving side zeromq</b> </p><div class="fragment"><div class="line">o2-dpl-raw-proxy --dataspec lasertracks:TPC/LASERTRACKS/0 --channel-config &quot;name=readout-proxy,type=pull,method=bind,address=tcp://localhost:30453,rateLogging=1,transport=zeromq&quot; \</div>
<div class="line">  | o2-tpc-laser-tracks-calibrator --write-debug --min-entries 100 --tf-per-slot 5000 --run</div>
</div><!-- fragment --><p><b>Sending side shmem</b> </p><div class="fragment"><div class="line">ARGS_ALL=&quot;--session tpc-laser-tracks -b&quot;</div>
<div class="line">o2-tpc-file-reader $ARGS_ALL --input-type tracks --disable-mc --tpc-track-reader &#39;--infile tpctracks.root&#39; \</div>
<div class="line"> | o2-tpc-laser-track-filter $ARGS_ALL \</div>
<div class="line"> | o2-dpl-output-proxy $ARGS_ALL --channel-config &quot;name=downstream,type=push,method=bind,address=ipc://@tpc-laser-tracks-0,transport=shmem,rateLogging=1&quot; --dataspec lasertracks:TPC/LASERTRACKS \</div>
<div class="line"> | o2-dpl-run $ARGS_ALL --run</div>
</div><!-- fragment --><p><b>Receeving side shmem</b> </p><div class="fragment"><div class="line">ARGS_ALL=&quot;--session tpc-laser-tracks -b&quot;</div>
<div class="line">o2-dpl-raw-proxy $ARGS_ALL --dataspec lasertracks:TPC/LASERTRACKS/0 --channel-config &quot;name=readout-proxy,type=pull,method=connect,address=ipc://@tpc-laser-tracks-0,transport=shmem,rateLogging=1&quot; \</div>
<div class="line">  | o2-tpc-laser-tracks-calibrator $ARGS_ALL --write-debug --min-entries 100 --tf-per-slot 5000 \</div>
<div class="line">  | o2-dpl-run $ARGS_ALL --run</div>
</div><!-- fragment --><h2>Running the recontruction on GBT raw data</h2>
<p>This requires to do zero suppression in the first stage. For this the <code>DigiDump</code> class is used, wrapped in an <a class="el" href="../../d4/d7c/namespaceo2.html" title="information complementary to a CCDB object (path, metadata, startTimeValidity, endTimeValidity etc)">o2</a> workflow.</p>
<p>Use either the <a href="../../#running-with-data-distribution">DD</a> part or <a href="../../#running-with-raw-file-playback">raw file playback</a> from above and add as processor </p><div class="fragment"><div class="line">| o2-tpc-raw-to-digits-workflow --pedestal-file pedestals.root --configKeyValues &quot;TPCDigitDump.ADCMin=3;TPCDigitDump.NoiseThreshold=3&quot; \</div>
<div class="line">| o2-tpc-reco-workflow --input-type digitizer --output-type tracks --disable-mc</div>
</div><!-- fragment --><p>To directly dump the digits to file for inspection use for the reco workflow </p><div class="fragment"><div class="line">| o2-tpc-reco-workflow --input-type digitizer --output-type digits --disable-mc</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d0/d2f/refDetectors.html">Module &#39;Detectors&#39;</a></li><li class="navelem"><a class="el" href="../../d5/d4d/refDetectorsTPC.html">TPC</a></li>
    <li class="footer">Generated on Mon Feb 14 2022 05:41:08 for Project by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
