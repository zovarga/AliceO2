<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: Decoder</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('df/d92/refDetectorsMUONMCHRawDecoder.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Decoder </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>MCH Raw Data Decoder</h1>
<p>There are currently two data formats to be dealt with : the "bare" one coming out of the CRU when no user logic (UL) is used, or the "UL" one where user logic is actually used. Each of the two formats can be used in charge sum (the sampa electronics does the charge integration) or in sample mode (the sampa electronics transmit all the charge samples). All formats are composed of {RawDataHeader,Payload} pairs.</p>
<p>The work of the MCH Raw Data decoder is to decode one single such pair, also called a (CRU) page. How the loop on the raw pages is done is <em>not</em> the decoder business.</p>
<h2>createPageDecoder</h2>
<p>On the reading/consumer/decoding end, the choice of the internal decoder to use is made using the data itself. You must give (at least) a part of a raw data buffer that contains a (valid) RawDataHeader. That RDH is used to deduce which implementation is picked. </p><pre class="fragment">gsl::span&lt;const std::byte&gt; rawbuffer = ... ;
auto pageDecoder = o2::mch::raw::createPageDecoder(rawbuffer,channelHandler);
</pre><p>The <code>pageDecoder</code> that is returned is a function that you have to call on each data page that you want to decode : </p><pre class="fragment">while(some_data_is_available) {
// get some memory buffer from somewhere ...
buffer = ...

// decode that buffer
pageDecode(buffer);
}
</pre><p>Internally the implementation is using templatized implementation, <code>PageDecoderImpl&lt;FORMAT,CHARGESUM,VERSION&gt;</code>. Currently the following template parameters combinations have been tested :</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">FORMAT </th><th class="markdownTableHeadCenter">CHARGESUM </th><th class="markdownTableHeadCenter">VERSION  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">BareFormat </td><td class="markdownTableBodyCenter">ChargeSumMode </td><td class="markdownTableBodyCenter">0  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">BareFormat </td><td class="markdownTableBodyCenter">SampleMode </td><td class="markdownTableBodyCenter">0  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">UserLogicFormat </td><td class="markdownTableBodyCenter">ChargeSumMode </td><td class="markdownTableBodyCenter">0  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">UserLogicFormat </td><td class="markdownTableBodyCenter">SampleMode </td><td class="markdownTableBodyCenter">0  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">UserLogicFormat </td><td class="markdownTableBodyCenter">ChargeSumMode </td><td class="markdownTableBodyCenter">1  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">UserLogicFormat </td><td class="markdownTableBodyCenter">SampleMode </td><td class="markdownTableBodyCenter">1  </td></tr>
</table>
<p>The <code>createPageDecoder</code> function requires two parameters : a raw memory buffer (in the form of a <code>gsl::span&lt;const std::byte&gt;</code> (note that the span is on constant bytes, i.e. the input buffer is read-only) and a <code>SampaChannelHandler</code>.</p>
<h2>SampaChannelHandler</h2>
<p>The <code>SampaChannelHandler</code> is a function, that takes a dual sampa identifier (in electronics realm, aka solar,group,index tuple), a channel identifier within that dual sampa (in the 0..63 range), a <code>SampaCluster</code> and returns nothing, i.e. :</p>
<blockquote class="doxtable">
<p><a class="el" href="../../d2/d88/classA.html">A</a> word of caution here about the naming. <a class="el" href="../../d2/d88/classA.html">A</a> <code>SampaCluster</code> is a group of raw data samples of <em>one</em> dual sampa channel, and has nothing to do with a cluster of pads or something alike. </p>
</blockquote>
<div class="fragment"><div class="line"><span class="keyword">using</span> <a class="code" href="../../d2/d26/namespaceo2_1_1mch_1_1raw.html#ab700473b58c58ef9a24f2765913c8cb9">SampaChannelHandler</a> = std::function&lt;<a class="code" href="../../dc/da3/glcorearb_8h.html#a950fc91edb4504f62f1c577bf4727c29">void</a>(DsElecId dsId,</div>
<div class="line">                                               <a class="code" href="../../d2/d26/namespaceo2_1_1mch_1_1raw.html#ac157101699fdaa444607efece17e0f7b">DualSampaChannelId</a> channel,</div>
<div class="line">                                               SampaCluster)&gt;;</div>
</div><!-- fragment --><p>That function is called by the raw data decoder for each <code>SampaCluster</code> that it finds in the data. <a class="el" href="../../d2/d88/classA.html">A</a> very simple example would be a function to dump the SampaClusters :</p>
<div class="fragment"><div class="line"><a class="code" href="../../d2/d26/namespaceo2_1_1mch_1_1raw.html#ab700473b58c58ef9a24f2765913c8cb9">SampaChannelHandler</a> <a class="code" href="../../d8/dcb/testUserLogicEndpointDecoder_8cxx.html#aec05af1ae95c60baf4db3d55e41c01fc">handlePacket</a>(DsElecId dsId, <a class="code" href="../../d2/d26/namespaceo2_1_1mch_1_1raw.html#ac157101699fdaa444607efece17e0f7b">DualSampaChannelId</a> channel, SampaCluster sc) {</div>
<div class="line">    std::cout &lt;&lt; <a class="code" href="../../dc/da3/glcorearb_8h.html#ae2d3db041c6004a67047659b42f73a44">fmt::format</a>(<span class="stringliteral">&quot;{}-ch-{}-ts-{}-q-{}&quot;</span>, <a class="code" href="../../d9/df7/ConfigurableParamHelper_8cxx.html#a8f4ab86e1e8a6141692ac3ebc5e6127b">asString</a>(dsId), channel, sc.timestamp, sc.chargeSum));</div>
<div class="line">}</div>
<div class="line"><span class="comment">// (note that this particular function only correctly handles the SampaCluster in ChargeSum Mode)</span></div>
</div><!-- fragment --><h2>Example of decoding raw data</h2>
<p><a class="el" href="../../d2/d88/classA.html">A</a> (not particularly clean) example of how to decode raw data can be found in the source of the <code>o2-mchraw-dump</code> executable <a href="../../../Tools/rawdump.cxx">rawdump</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div class="ttc" id="aglcorearb_8h_html_ae2d3db041c6004a67047659b42f73a44"><div class="ttname"><a href="../../dc/da3/glcorearb_8h.html#ae2d3db041c6004a67047659b42f73a44">format</a></div><div class="ttdeci">GLint GLint GLsizei GLint GLenum format</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/da3/glcorearb_8h_source.html#l00275">glcorearb.h:275</a></div></div>
<div class="ttc" id="anamespaceo2_1_1mch_1_1raw_html_ac157101699fdaa444607efece17e0f7b"><div class="ttname"><a href="../../d2/d26/namespaceo2_1_1mch_1_1raw.html#ac157101699fdaa444607efece17e0f7b">o2::mch::raw::DualSampaChannelId</a></div><div class="ttdeci">uint6_t DualSampaChannelId</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d64/DataFormats_8h_source.html#l00065">DataFormats.h:65</a></div></div>
<div class="ttc" id="anamespaceo2_1_1mch_1_1raw_html_ab700473b58c58ef9a24f2765913c8cb9"><div class="ttname"><a href="../../d2/d26/namespaceo2_1_1mch_1_1raw.html#ab700473b58c58ef9a24f2765913c8cb9">o2::mch::raw::SampaChannelHandler</a></div><div class="ttdeci">std::function&lt; void(DsElecId dsId, DualSampaChannelId channel, SampaCluster)&gt; SampaChannelHandler</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dd8/DecodedDataHandlers_8h_source.html#l00030">DecodedDataHandlers.h:30</a></div></div>
<div class="ttc" id="aConfigurableParamHelper_8cxx_html_a8f4ab86e1e8a6141692ac3ebc5e6127b"><div class="ttname"><a href="../../d9/df7/ConfigurableParamHelper_8cxx.html#a8f4ab86e1e8a6141692ac3ebc5e6127b">asString</a></div><div class="ttdeci">std::string asString(TDataMember const &amp;dm, char *pointer)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df7/ConfigurableParamHelper_8cxx_source.html#l00142">ConfigurableParamHelper.cxx:142</a></div></div>
<div class="ttc" id="aglcorearb_8h_html_a950fc91edb4504f62f1c577bf4727c29"><div class="ttname"><a href="../../dc/da3/glcorearb_8h.html#a950fc91edb4504f62f1c577bf4727c29">void</a></div><div class="ttdeci">typedef void(APIENTRYP PFNGLCULLFACEPROC)(GLenum mode)</div></div>
<div class="ttc" id="atestUserLogicEndpointDecoder_8cxx_html_aec05af1ae95c60baf4db3d55e41c01fc"><div class="ttname"><a href="../../d8/dcb/testUserLogicEndpointDecoder_8cxx.html#aec05af1ae95c60baf4db3d55e41c01fc">handlePacket</a></div><div class="ttdeci">SampaChannelHandler handlePacket(std::string &amp;result)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dcb/testUserLogicEndpointDecoder_8cxx_source.html#l00109">testUserLogicEndpointDecoder.cxx:109</a></div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d0/d2f/refDetectors.html">Module &#39;Detectors&#39;</a></li><li class="navelem"><a class="el" href="../../d4/dff/refDetectorsMUON.html">MUON</a></li><li class="navelem"><a class="el" href="../../d0/daf/refDetectorsMUONMCH.html">MCH</a></li><li class="navelem"><a class="el" href="../../d4/dea/refDetectorsMUONMCHRaw.html">Raw CoDec</a></li>
    <li class="footer">Generated on Mon Feb 14 2022 05:41:08 for Project by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
